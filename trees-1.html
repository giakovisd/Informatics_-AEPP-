<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î”Î¿Î¼Î­Ï‚ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: Î”Î­Î½Î´ÏÎ±</title>
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --panel-bg: #ffffff;
            --highlight-line: #fde047;
            
            --col-main: #3b82f6; 
            --col-sec: #8b5cf6;  
            --col-success: #10b981; 
            --col-error: #ef4444;
            
            --node-bg: #ffffff;
            --node-stroke: #3b82f6;
            --node-highlight: #f97316; /* Orange for active */
            
            --border-color: #cbd5e1;
            --disabled-btn: #94a3b8;

            /* Code Syntax */
            --code-kw: #0000CD; 
            --code-sym: #FF0000; 
            --code-var: #000000; 
            --code-num: #008000;
            --code-str: #A020F0;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            box-sizing: border-box;
            flex-shrink: 0;
            z-index: 100;
        }

        .header-title h1 { margin: 0; font-size: 1.1rem; }
        .controls-area { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

        button {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            background-color: var(--panel-bg);
            color: var(--text-color);
            transition: all 0.2s;
            white-space: nowrap;
        }
        button.primary { background-color: var(--col-main); color: white; border: none; }
        button:hover:not(:disabled) { filter: brightness(0.95); transform: translateY(-1px); }
        button:disabled { background-color: var(--disabled-btn); color: #fff; cursor: not-allowed; }

        .slider-container { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; margin-left: 10px; }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            padding: 15px;
            gap: 15px;
            height: calc(100% - 70px);
            box-sizing: border-box;
            overflow: hidden; 
        }

        /* LEFT: Panel (Controls & Info) */
        .col-left {
            flex: 0 0 420px;
            display: flex;
            flex-direction: column;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .tabs { display: flex; flex-direction: column; background: #f1f5f9; border-bottom: 1px solid var(--border-color); }
        .tab {
            text-align: left; padding: 10px 15px; font-size: 0.9rem; cursor: pointer;
            border-left: 4px solid transparent; border-bottom: 1px solid #e2e8f0; color: #64748b; font-weight: bold;
        }
        .tab:hover { background: #e2e8f0; }
        .tab.active { background: var(--panel-bg); border-left-color: var(--col-main); color: var(--text-color); }

        .panel-content {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px;
        }

        .info-box {
            background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 10px; font-size: 0.9rem; line-height: 1.4; color: #1e3a8a;
        }
        .info-header { font-weight: bold; display: block; margin-bottom: 5px; color: #1e40af; }

        .control-group { border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; background: #fff; }
        .control-label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #64748b; }
        
        select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #cbd5e1; margin-bottom: 8px; }

        /* Code Display (for BST) */
        .code-display {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; 
            padding: 10px; font-family: 'Consolas', monospace; font-size: 0.85rem;
            display: none; /* Hidden unless needed */
        }
        .code-line { padding: 2px 4px; border-radius: 2px; }
        .code-line.active { background-color: var(--highlight-line); font-weight: bold; }

        /* CENTER: Visualization */
        .col-viz {
            flex: 1;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 0;
            position: relative;
            overflow: hidden; 
        }

        .narrative {
            padding: 10px 15px;
            background: rgba(59, 130, 246, 0.1); 
            border-left: 4px solid var(--col-main);
            font-size: 0.95rem;
            font-style: italic;
            min-height: 40px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .scene-wrapper {
            flex: 1;
            width: 100%;
            height: 100%;
            overflow: auto; /* Allow scrolling if tree is huge */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            background-color: #f8fafc;
            position: relative;
        }

        /* SVG Styles */
        svg { width: 100%; height: 100%; min-height: 500px; min-width: 600px; }
        
        .tree-node rect {
            fill: var(--node-bg); stroke: var(--node-stroke); stroke-width: 2; rx: 8; ry: 8;
            transition: all 0.3s; cursor: pointer;
        }
        .tree-node text {
            font-family: 'Segoe UI', sans-serif; font-size: 14px; font-weight: 600;
            text-anchor: middle; dominant-baseline: middle; pointer-events: none; fill: var(--text-color);
        }
        .tree-link { stroke: #94a3b8; stroke-width: 2; fill: none; transition: stroke 0.3s; }
        
        /* States */
        .tree-node.selected rect { fill: var(--col-main); stroke: #1e40af; }
        .tree-node.selected text { fill: white; }
        
        .tree-node.highlight rect { stroke: var(--node-highlight); stroke-width: 3; fill: #fff7ed; }
        .tree-link.highlight { stroke: var(--node-highlight); stroke-width: 3; }

        .tree-node.correct rect { fill: var(--col-success); stroke: #047857; }
        .tree-node.correct text { fill: white; }
        
        .tree-node.wrong rect { fill: var(--col-error); stroke: #b91c1c; }
        .tree-node.wrong text { fill: white; }

        /* Animation Ball */
        .anim-ball { fill: var(--node-highlight); }

        /* RIGHT: Output */
        .col-output {
            flex: 0 0 220px;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .output-header { padding: 10px; background: #f1f5f9; font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .output-log { flex: 1; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.9rem; }
        .log-item { border-bottom: 1px solid #eee; padding: 5px 0; }
        .log-success { color: var(--col-success); font-weight: bold; }
        .log-error { color: var(--col-error); font-weight: bold; }

        /* Helper classes */
        .kw { color: var(--code-kw); font-weight: bold; } 
        .sym { color: var(--code-sym); font-weight: bold; }
        .var { color: var(--code-var); }
        .num { color: var(--code-num); font-weight: bold; }
        .str { color: var(--code-str); }

    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1>Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÎ® Î•Ï†Î±ÏÎ¼Î¿Î³Î®: Î”Î­Î½Î´ÏÎ±</h1>
    </div>
    
    <div class="controls-area">
        <button onclick="initCurrentMode()">ğŸ”„ Î‘ÏÏ‡Î®</button>
        <div id="bstControls" style="display:none; gap:5px;">
            <button onclick="playBST()" id="btnPlay" class="primary">â–¶ï¸ Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®</button>
            <button onclick="stepBST()" id="btnStep">Î’Î®Î¼Î± â©</button>
        </div>
        
        <div class="slider-container">
            <span>Î¤Î±Ï‡ÏÏ„Î·Ï„Î±:</span>
            <input type="range" min="200" max="2000" value="800" id="speedSlider" oninput="updateSpeed()">
        </div>
    </div>
</header>

<div class="main-container">
    
    <div class="col-left">
        <div class="tabs">
            <div class="tab active" onclick="setMode('general')">1. Î“ÎµÎ½Î¹ÎºÎ¬ Î”Î­Î½Î´ÏÎ± (Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚)</div>
            <div class="tab" onclick="setMode('binary')">2. Î”Ï…Î±Î´Î¹ÎºÎ¬ Î”Î­Î½Î´ÏÎ± (Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®)</div>
            <div class="tab" onclick="setMode('bst')">3. Î”Î”Î‘ (Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· & Î‘ÏƒÎºÎ®ÏƒÎµÎ¹Ï‚)</div>
            <div class="tab" onclick="setMode('decision')">4. Î”Î­Î½Î´ÏÎ± Î‘Ï€ÏŒÏ†Î±ÏƒÎ·Ï‚ (Î£ÎµÎ½Î¬ÏÎ¹Î±)</div>
        </div>

        <div class="panel-content" id="panelContent">
            </div>
    </div>

    <div class="col-viz">
        <div class="narrative" id="narrativeBox">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î¹Î± ÎºÎ±ÏÏ„Î­Î»Î± Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ...</div>
        
        <div class="scene-wrapper" id="sceneWrapper">
            <svg id="treeSvg"></svg>
        </div>
    </div>

    <div class="col-output">
        <div class="output-header">ğŸ“º Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ / Î•Ï€ÎµÎ¾Î·Î³Î®ÏƒÎµÎ¹Ï‚</div>
        <div class="output-log" id="outputLog"></div>
    </div>

</div>

<script>
    // --- Global State ---
    let currentMode = 'general';
    let speed = 1200;
    let nodes = []; // {id, label, x, y, children[], parent}
    let nextId = 1;
    let svg = document.getElementById('treeSvg');
    let width = 0, height = 0;
    
    // Mode specific state
    let generalQuestion = null; // {type, targetIds}
    let selectedNodeIds = new Set();
    
    let bstInsertVal = null;
    let bstPath = [];
    let bstStepIdx = -1;
    let bstTimer = null;
    
    // Exercises Data from PDF/File
    const bstExercises = {
        ex1: { label: "Î†ÏƒÎºÎ·ÏƒÎ· 49: 45, 23, 40, 78, 56, 100...", vals: [45, 23, 40, 78, 56, 100, 4, 9, 80, 30] },
        ex2: { label: "Î†ÏƒÎºÎ·ÏƒÎ· 50: 6, 18, 14, 9, 15...", vals: [6, 18, 14, 9, 15, 21, 11, 5, 3, 31] },
        ex3: { label: "Î†ÏƒÎºÎ·ÏƒÎ· 60: 55, 144, 21, 34...", vals: [55, 144, 21, 34, 89, 5, 233, 13] },
        ex4: { label: "Î†ÏƒÎºÎ·ÏƒÎ· 44 (Î“ÏÎ¬Î¼Î¼Î±Ï„Î±): Î£, Î¥, Î, Î, Î•, Î¦, Î™, Î‘", vals: ['Î£','Î¥','Î','Î','Î•','Î¦','Î™','Î‘'], type: 'char' }
    };

    const decisionScenarios = {
        house: { title: "ÎšÎ±Î¸Î±ÏÎ¹ÏŒÏ„Î·Ï„Î± Î£Ï€Î¹Ï„Î¹Î¿Ï", root: { label: "ÎšÎ±Î¸Î±ÏÏŒ Î£Ï€Î¯Ï„Î¹;", yes: "Î§Î±Î»Î¬ÏÏ‰ÏƒÎ·!", no: { label: "ÎšÎ±Î¸Î±ÏÏŒ Î Î¬Ï„Ï‰Î¼Î±;", yes: "Î Î±ÏÎ¬Î¸Ï…ÏÎ±", no: "Î£Ï†Î¿Ï…Î³Î³Î¬ÏÎ¹ÏƒÎ¼Î±" } } },
        exam: { title: "Î”Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î±", root: { label: "Î’Î±Î¸Î¼ÏŒÏ‚ >= 15;", yes: "Î’ÏŒÎ»Ï„Î±", no: { label: "Î†Î»Î»Î¿ Ï„ÎµÏƒÏ„ ÏƒÏÎ½Ï„Î¿Î¼Î±;", yes: "Î”Î¹Î¬Î²Î±ÏƒÎ¼Î±", no: "ÎÎµÎºÎ¿ÏÏÎ±ÏƒÎ·" } } }
    };

    // --- Init ---
    function initCurrentMode() {
        // Clear state
        nodes = [];
        nextId = 1;
        selectedNodeIds.clear();
        document.getElementById('outputLog').innerHTML = '';
        clearInterval(bstTimer);
        
        resizeSvg();

        if(currentMode === 'general') initGeneral();
        else if(currentMode === 'binary') initBinary();
        else if(currentMode === 'bst') initBST();
        else if(currentMode === 'decision') initDecision();
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        // Find tab by onclick attribute approximation or index (simple logic here)
        const tabs = document.querySelectorAll('.tab');
        if(m==='general') tabs[0].classList.add('active');
        if(m==='binary') tabs[1].classList.add('active');
        if(m==='bst') tabs[2].classList.add('active');
        if(m==='decision') tabs[3].classList.add('active');

        // Update Left Panel UI
        updateLeftPanel();
        
        // Show/Hide Top Controls
        document.getElementById('bstControls').style.display = (m === 'bst') ? 'flex' : 'none';

        initCurrentMode();
    }

    function updateLeftPanel() {
        const p = document.getElementById('panelContent');
        p.innerHTML = '';

        if(currentMode === 'general') {
            p.innerHTML = `
                <div class="info-box">
                    <span class="info-header">ÎŸÏÎ¹ÏƒÎ¼Î¿Î¯:</span>
                    <ul>
                        <li><b>Î¡Î¯Î¶Î±:</b> ÎŸ ÎºÎ¿ÏÏ…Ï†Î±Î¯Î¿Ï‚ ÎºÏŒÎ¼Î²Î¿Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ Î³Î¿Î½Î­Î±).</li>
                        <li><b>Î¦ÏÎ»Î»Î±:</b> ÎšÏŒÎ¼Î²Î¿Î¹ Ï‡Ï‰ÏÎ¯Ï‚ Ï€Î±Î¹Î´Î¹Î¬.</li>
                        <li><b>Î Î±Î¹Î´Î¹Î¬:</b> ÎšÏŒÎ¼Î²Î¿Î¹ Ï€Î¿Ï… ÏƒÏ…Î½Î´Î­Î¿Î½Ï„Î±Î¹ ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ Î­Î½Î±Î½ Î¬Î»Î»Î¿.</li>
                    </ul>
                </div>
                <div class="control-group">
                    <span class="control-label">Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚:</span>
                    <button class="primary" style="width:100%; margin-bottom:5px;" onclick="initGeneral()">ğŸ² ÎÎ­Î¿ Î¤Ï…Ï‡Î±Î¯Î¿ Î”Î­Î½Î´ÏÎ¿</button>
                    <button style="width:100%; margin-bottom:5px;" onclick="askQuestion()">â“ ÎÎ­Î± Î•ÏÏÏ„Î·ÏƒÎ·</button>
                    <button class="primary" style="width:100%;" onclick="checkGeneralAnswer()">âœ… ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚</button>
                </div>
                <div id="questionBox" class="info-box" style="background:#fff; border-color:#cbd5e1; display:none;"></div>
            `;
        } else if(currentMode === 'binary') {
            p.innerHTML = `
                <div class="info-box">
                    <span class="info-header">Î”Ï…Î±Î´Î¹ÎºÏŒ Î”Î­Î½Î´ÏÎ¿:</span>
                    ÎšÎ¬Î¸Îµ ÎºÏŒÎ¼Î²Î¿Ï‚ Î­Ï‡ÎµÎ¹ Ï„Î¿ Ï€Î¿Î»Ï 2 Ï€Î±Î¹Î´Î¹Î¬.
                </div>
                <div class="control-group">
                    <span class="control-label">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ÎšÏŒÎ¼Î²Î¿Ï…:</span>
                    <p style="font-size:0.85rem; margin-bottom:10px;">ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº ÏƒÎµ Î­Î½Î± <b>Ï†ÏÎ»Î»Î¿</b> Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Ï€Î±Î¹Î´Î¯.</p>
                    <button class="primary" style="width:100%;" onclick="initBinary()">ğŸ² ÎÎ­Î¿ Î”Î­Î½Î´ÏÎ¿</button>
                </div>
            `;
        } else if(currentMode === 'bst') {
            p.innerHTML = `
                <div class="info-box">
                    <span class="info-header">Î”Î”Î‘ (BST):</span>
                    Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬ &lt; Î¡Î¯Î¶Î±, Î”ÎµÎ¾Î¹Î¬ &ge; Î¡Î¯Î¶Î±.
                </div>
                <div class="control-group">
                    <span class="control-label">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î¤Î¹Î¼Î®Ï‚:</span>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="bstValInput" placeholder="Î¤Î¹Î¼Î®" style="width:70px;">
                        <button class="primary" onclick="prepareBSTInsert()">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®</button>
                    </div>
                </div>
                <div class="control-group">
                    <span class="control-label">Î‘ÏƒÎºÎ®ÏƒÎµÎ¹Ï‚ Î¦Ï…Î»Î»Î±Î´Î¯Î¿Ï…:</span>
                    <select id="exSelect" onchange="loadExercise()">
                        <option value="">-- Î•Ï€Î¹Î»Î­Î¾Ï„Îµ --</option>
                        <option value="ex1">Î†ÏƒÎºÎ·ÏƒÎ· 49</option>
                        <option value="ex2">Î†ÏƒÎºÎ·ÏƒÎ· 50</option>
                        <option value="ex3">Î†ÏƒÎºÎ·ÏƒÎ· 60</option>
                        <option value="ex4">Î†ÏƒÎºÎ·ÏƒÎ· 44 (Î“ÏÎ¬Î¼Î¼Î±Ï„Î±)</option>
                    </select>
                </div>
                <div class="code-display" id="bstCode">
<div class="code-line" id="l1">Î‘Î½ ÏÎ¯Î¶Î± ÎºÎµÎ½Î®:</div>
<div class="code-line" id="l2">  Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ ÎºÏŒÎ¼Î²Î¿</div>
<div class="code-line" id="l3">Î‘Î»Î»Î¹ÏÏ‚ Î‘Î½ Ï„Î¹Î¼Î® < Ï„ÏÎ­Ï‡Î¿Î½:</div>
<div class="code-line" id="l4">  Î Î®Î³Î±Î¹Î½Îµ Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬</div>
<div class="code-line" id="l5">Î‘Î»Î»Î¹ÏÏ‚:</div>
<div class="code-line" id="l6">  Î Î®Î³Î±Î¹Î½Îµ Î”ÎµÎ¾Î¹Î¬</div>
                </div>
            `;
        } else if(currentMode === 'decision') {
            p.innerHTML = `
                <div class="info-box">
                    <span class="info-header">Î”Î­Î½Î´ÏÎ± Î‘Ï€ÏŒÏ†Î±ÏƒÎ·Ï‚:</span>
                    Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ Î³Î¹Î± Î»Î®ÏˆÎ· Î±Ï€Î¿Ï†Î¬ÏƒÎµÏ‰Î½ Î²Î¬ÏƒÎµÎ¹ ÎµÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½ (ÎÎ±Î¹/ÎŒÏ‡Î¹).
                </div>
                <div class="control-group">
                    <span class="control-label">Î£ÎµÎ½Î¬ÏÎ¹Î±:</span>
                    <button style="width:100%; margin-bottom:5px;" onclick="loadDecision('house')">ğŸ  ÎšÎ±Î¸Î±ÏÎ¹ÏŒÏ„Î·Ï„Î±</button>
                    <button style="width:100%; margin-bottom:5px;" onclick="loadDecision('exam')">ğŸ“ Î”Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î±</button>
                </div>
            `;
        }
    }

    // --- Logic: General Trees ---
    function initGeneral() {
        nodes = [];
        // Simple random tree generator
        let root = createNode(null, "Î¡Î¯Î¶Î±");
        nodes.push(root);
        
        // Add random children levels
        let queue = [root];
        let idCounter = 2;
        let labels = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        
        while(nodes.length < 8 && queue.length > 0) {
            let parent = queue.shift();
            let childrenCount = Math.floor(Math.random() * 3) + 1; // 1-3 children
            for(let i=0; i<childrenCount; i++) {
                if(nodes.length >= 10) break;
                let child = createNode(parent, labels[idCounter-2] || idCounter);
                parent.children.push(child);
                nodes.push(child);
                queue.push(child);
                idCounter++;
            }
        }
        recalcLayout();
        drawTree();
        narrate("Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Ï„Ï…Ï‡Î±Î¯Î¿ Î´Î­Î½Î´ÏÎ¿. Î Î±Ï„Î®ÏƒÏ„Îµ 'ÎÎ­Î± Î•ÏÏÏ„Î·ÏƒÎ·'.");
        document.getElementById('questionBox').style.display = 'none';
        selectedNodeIds.clear();
    }

    function askQuestion() {
        const types = ['root', 'leaf', 'child'];
        const type = types[Math.floor(Math.random()*types.length)];
        let qText = "";
        
        selectedNodeIds.clear();
        drawTree(); // clear selection visuals

        if(type === 'root') {
            generalQuestion = { type: 'root', answer: [nodes[0].id] };
            qText = "Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î· <b>Î¡Î¯Î¶Î±</b> Ï„Î¿Ï… Î´Î­Î½Î´ÏÎ¿Ï….";
        } else if(type === 'leaf') {
            let leaves = nodes.filter(n => n.children.length === 0).map(n => n.id);
            generalQuestion = { type: 'leaf', answer: leaves };
            qText = "Î•Ï€Î¹Î»Î­Î¾Ï„Îµ <b>ÏŒÎ»Î± Ï„Î± Î¦ÏÎ»Î»Î±</b>.";
        } else {
            // Find a node with children
            let parents = nodes.filter(n => n.children.length > 0);
            let target = parents[Math.floor(Math.random()*parents.length)];
            let childrenIds = target.children.map(c => c.id);
            generalQuestion = { type: 'child', answer: childrenIds };
            qText = `Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î± <b>Ï€Î±Î¹Î´Î¹Î¬</b> Ï„Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï… <b>${target.label}</b>.`;
        }

        const box = document.getElementById('questionBox');
        box.style.display = 'block';
        box.innerHTML = `<span class="info-header">Î•ÏÏÏ„Î·ÏƒÎ·:</span>${qText}`;
        narrate(qText.replace(/<[^>]*>/g, ''));
    }

    function toggleSelection(id) {
        if(selectedNodeIds.has(id)) selectedNodeIds.delete(id);
        else selectedNodeIds.add(id);
        drawTree();
    }

    function checkGeneralAnswer() {
        if(!generalQuestion) return;
        
        // Compare sets
        let correct = true;
        if(selectedNodeIds.size !== generalQuestion.answer.length) correct = false;
        else {
            for(let id of generalQuestion.answer) {
                if(!selectedNodeIds.has(id)) correct = false;
            }
        }

        const log = document.getElementById('outputLog');
        if(correct) {
            log.innerHTML += `<div class="log-item log-success">âœ… Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·!</div>`;
            narrate("ÎœÏ€ÏÎ¬Î²Î¿! Î£Ï‰ÏƒÏ„Î® Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.");
            // Mark correct visually
            nodes.forEach(n => {
                if(selectedNodeIds.has(n.id)) n.status = 'correct';
            });
        } else {
            log.innerHTML += `<div class="log-item log-error">âŒ Î›Î¬Î¸Î¿Ï‚. Î ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î¾Î±Î½Î¬.</div>`;
            narrate("Î›Î¬Î¸Î¿Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î®. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.");
            nodes.forEach(n => {
                if(selectedNodeIds.has(n.id) && !generalQuestion.answer.includes(n.id)) n.status = 'wrong';
            });
        }
        drawTree();
        setTimeout(() => { 
            nodes.forEach(n => n.status = null); // clear status
            drawTree();
        }, 2000);
    }

    // --- Logic: Binary Tree ---
    function initBinary() {
        initGeneral(); // Use same generator but enforce binary constraint?
        // Enforce max 2 children for cleanliness
        nodes.forEach(n => {
            if(n.children.length > 2) n.children = n.children.slice(0, 2);
        });
        recalcLayout();
        drawTree();
        narrate("ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº ÏƒÎµ Î­Î½Î± Î¦ÏÎ»Î»Î¿ Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ Ï€Î±Î¹Î´Î¯.");
    }

    function addBinaryNode(parentId) {
        const parent = nodes.find(n => n.id === parentId);
        if(parent.children.length >= 2) {
            narrate("ÎŸ ÎºÏŒÎ¼Î²Î¿Ï‚ Î­Ï‡ÎµÎ¹ Î®Î´Î· 2 Ï€Î±Î¹Î´Î¹Î¬.");
            return;
        }
        let newVal = Math.floor(Math.random()*100);
        let newNode = createNode(parent, newVal);
        parent.children.push(newNode);
        nodes.push(newNode);
        
        recalcLayout();
        drawTree();
        
        // Animate path
        highlightPathTo(newNode);
        narrate(`Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÎºÏŒÎ¼Î²Î¿Ï‚ ${newVal} ÏƒÏ„Î¿Î½ ${parent.label}.`);
    }

    // --- Logic: BST ---
    function initBST() {
        nodes = [];
        nextId = 1;
        document.getElementById('bstCode').style.display = 'block';
        narrate("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¹Î¼Î® Î® ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î¬ÏƒÎºÎ·ÏƒÎ·.");
        drawTree();
    }

    function prepareBSTInsert() {
        let val = document.getElementById('bstValInput').value;
        if(!val) val = Math.floor(Math.random()*99);
        bstInsertVal = parseInt(val); // Assuming numbers primarily
        
        // Check if char exercise
        const exSelect = document.getElementById('exSelect');
        if(exSelect && exSelect.value === 'ex4') {
             // Handle chars logic if needed, simplify to strings
             bstInsertVal = String(val).toUpperCase();
        }

        startBSTAnimation(bstInsertVal);
    }

    function loadExercise() {
        const key = document.getElementById('exSelect').value;
        if(!key) return;
        
        initBST();
        const data = bstExercises[key];
        narrate(data.label);
        
        // Auto insert all sequentially for demo? Or just prep?
        // Let's insert them one by one with delays
        let i = 0;
        function next() {
            if(i >= data.vals.length) return;
            startBSTAnimation(data.vals[i], () => {
                i++;
                setTimeout(next, 500);
            });
        }
        next();
    }

    function startBSTAnimation(val, onComplete) {
        if(nodes.length === 0) {
            let root = createNode(null, val);
            nodes.push(root);
            recalcLayout();
            drawTree();
            log(`Î¡Î¯Î¶Î±: ${val}`);
            if(onComplete) onComplete();
            return;
        }

        // Trace path
        let curr = nodes[0]; // root
        bstPath = [];
        let parent = null;
        let dir = '';

        while(curr) {
            bstPath.push({node: curr, step: 'compare'});
            parent = curr;
            if(val < curr.label) {
                bstPath.push({node: curr, step: 'left'});
                // Find left child
                let left = curr.children.find(c => c.label < curr.label); // Logic simplification: relies on structure
                // Actually structure holds children. In BST layout, children[0] is usually left. 
                // We need proper left/right pointers. 
                // For this viz, we will infer from values or store explicitly.
                // Let's assume children are ordered or use explicit prop.
                
                // Better: find child with value < curr
                // Since this is visualization, we just look at children array.
                // WE NEED TO INSERT CORRECTLY FIRST.
                
                let next = null;
                // Find visually left child (in layout x < parent.x)
                // But we don't have layout yet.
                // We need logic structure.
                if(!curr.left && !curr.right) {
                    // Check children array?
                    // Let's stick to simple logic: we insert node then animate to it.
                }
                
                // Let's pre-calculate insertion
                if(curr.left) { curr = curr.left; dir='left'; }
                else { dir='left_insert'; break; }
            } else {
                bstPath.push({node: curr, step: 'right'});
                if(curr.right) { curr = curr.right; dir='right'; }
                else { dir='right_insert'; break; }
            }
        }

        // Add node
        let newNode = createNode(parent, val);
        if(dir.startsWith('left')) parent.left = newNode;
        else parent.right = newNode;
        parent.children.push(newNode); // for generic layout
        nodes.push(newNode);
        recalcLayout();
        drawTree();

        // Animate
        animateBSTPath(bstPath, newNode, onComplete);
    }

    function animateBSTPath(path, targetNode, cb) {
        let i = 0;
        
        function loop() {
            if(i >= path.length) {
                narrate(`Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ${targetNode.label}`);
                log(`Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ${targetNode.label}`);
                if(cb) cb();
                return;
            }
            
            let p = path[i];
            // Highlight node
            resetHighlights();
            p.node.highlight = true;
            
            // Highlight code
            let codeId = '';
            if(p.step === 'compare') {
                narrate(`Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ${targetNode.label} Î¼Îµ ${p.node.label}`);
                codeId = 'l3'; // Else If
            } else if(p.step === 'left') {
                narrate("ÎœÎ¹ÎºÏÏŒÏ„ÎµÏÎ¿ -> Î‘ÏÎ¹ÏƒÏ„ÎµÏÎ¬");
                codeId = 'l4';
            } else {
                narrate("ÎœÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ -> Î”ÎµÎ¾Î¹Î¬");
                codeId = 'l6';
            }
            highlightCode(codeId);
            drawTree();
            
            i++;
            setTimeout(loop, speed);
        }
        loop();
    }

    // --- Logic: Decision Trees ---
    function initDecision() {
        nodes = [];
        narrate("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± ÏƒÎµÎ½Î¬ÏÎ¹Î¿.");
        drawTree();
    }

    function loadDecision(key) {
        const data = decisionScenarios[key];
        nodes = [];
        // Parse recursive obj to nodes
        function parse(obj, parent) {
            let n = createNode(parent, obj.label || obj);
            nodes.push(n);
            if(parent) parent.children.push(n);
            
            if(obj.yes) {
                // Ideally denote Yes/No on links. visualization handles simple tree.
                parse(obj.yes, n);
            }
            if(obj.no) {
                parse(obj.no, n);
            }
        }
        parse(data.root, null);
        recalcLayout();
        drawTree();
        narrate(`Î£ÎµÎ½Î¬ÏÎ¹Î¿: ${data.title}`);
        log(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ: ${data.title}`);
    }

    // --- Core Tree Logic ---
    function createNode(parent, label) {
        return {
            id: nextId++,
            label: label,
            x: 0, y: 0,
            children: [],
            parent: parent,
            left: null, right: null, // For BST
            highlight: false,
            status: null // 'correct', 'wrong'
        };
    }

    function recalcLayout() {
        // Simple Reingold-Tilford-like layout or basic level-based
        if(nodes.length === 0) return;
        
        let root = nodes[0];
        // Reset
        nodes.forEach(n => { n.x=0; n.y=0; });

        // Calculate levels
        let levels = {};
        function getLevel(n, d) {
            if(!levels[d]) levels[d] = [];
            levels[d].push(n);
            n.y = 50 + d * 80;
            n.children.forEach(c => getLevel(c, d+1));
        }
        getLevel(root, 0);

        // Assign X - simple spread
        // A better way is to assign ranges.
        let canvasW = svg.clientWidth || 800;
        
        function assignX(node, minX, maxX) {
            let myX = (minX + maxX) / 2;
            node.x = myX;
            let width = maxX - minX;
            let slice = width / node.children.length;
            node.children.forEach((c, i) => {
                assignX(c, minX + i*slice, minX + (i+1)*slice);
            });
        }
        assignX(root, 0, canvasW);
    }

    function drawTree() {
        let html = '';
        
        // Links
        nodes.forEach(n => {
            n.children.forEach(c => {
                html += `<line x1="${n.x}" y1="${n.y}" x2="${c.x}" y2="${c.y}" class="tree-link" />`;
                // Add labels for Decision Tree?
                if(currentMode === 'decision') {
                    // Hacky check: first child No, second Yes usually in my structure order
                    // Or check position
                    let txt = (c.x < n.x) ? "ÎŒÏ‡Î¹" : "ÎÎ±Î¹";
                    html += `<text x="${(n.x+c.x)/2}" y="${(n.y+c.y)/2 - 5}" font-size="11" fill="#64748b">${txt}</text>`;
                }
            });
        });

        // Nodes
        nodes.forEach(n => {
            let cls = 'tree-node';
            if(selectedNodeIds.has(n.id)) cls += ' selected';
            if(n.highlight) cls += ' highlight';
            if(n.status) cls += ' ' + n.status;
            
            // Calc width based on text
            let w = Math.max(40, String(n.label).length * 9 + 20);
            
            html += `
            <g class="${cls}" onclick="handleNodeClick(${n.id})" transform="translate(${n.x}, ${n.y})">
                <rect x="${-w/2}" y="-15" width="${w}" height="30"></rect>
                <text>${n.label}</text>
            </g>
            `;
        });

        svg.innerHTML = html;
    }

    function handleNodeClick(id) {
        if(currentMode === 'general') {
            toggleSelection(id);
        } else if(currentMode === 'binary') {
            // Check if leaf
            let n = nodes.find(x => x.id === id);
            if(n.children.length === 0 || (n.children.length < 2)) {
                addBinaryNode(id);
            }
        }
    }

    // --- Helpers ---
    function log(msg) {
        document.getElementById('outputLog').innerHTML += `<div class="log-item">${msg}</div>`;
        let el = document.getElementById('outputLog');
        el.scrollTop = el.scrollHeight;
    }
    
    function narrate(msg) {
        document.getElementById('narrativeBox').innerText = msg;
    }

    function highlightCode(id) {
        document.querySelectorAll('.code-line').forEach(el => el.classList.remove('active'));
        if(id) document.getElementById(id).classList.add('active');
    }

    function resetHighlights() {
        nodes.forEach(n => n.highlight = false);
    }

    function highlightPathTo(node) {
        // Trace back to root
        let curr = node;
        while(curr) {
            curr.highlight = true;
            curr = curr.parent;
        }
        drawTree();
        setTimeout(resetHighlights, 1000);
        setTimeout(drawTree, 1000);
    }

    function resizeSvg() {
        width = document.getElementById('sceneWrapper').clientWidth;
        height = document.getElementById('sceneWrapper').clientHeight;
    }

    function updateSpeed() {
        speed = 2200 - document.getElementById('speedSlider').value;
    }

    // Resize listener
    window.onresize = () => { resizeSvg(); recalcLayout(); drawTree(); };

    // Initial
    setMode('general');

</script>
</body>
</html>