<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® ÏƒÎµ Î›Î¯ÏƒÏ„Î±</title>
    <style>
        :root {
            /* Light Mode */
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --panel-bg: #ffffff;
            --highlight-line: #fef08a;
            --border-color: #cbd5e1;
            
            --node-bg: #ffffff;
            --node-border: #334155;
            
            /* Memory Colors */
            --mem-bg: #f1f5f9;
            --mem-cell-border: #94a3b8;
            --mem-active: #dcfce7; 
            --mem-head: #e9d5ff;   
            --mem-new: #fef08a;    
            --mem-txt: #0f172a;
            
            --arrow-color: #334155;
            --pointer-txt: #dc2626; 
            
            --btn-white-bg: #ffffff;
            --btn-white-text: #1e293b;
            --btn-white-border: #cbd5e1;
            
            --btn-blue: #3b82f6;
            --btn-blue-hover: #2563eb;
            
            --code-kw: #0000CD;
            --code-sym: #FF0000;
            --code-txt: #000000;
            
            --disabled-btn: #94a3b8;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --panel-bg: #1e293b;
            --highlight-line: #334155;
            --border-color: #475569;
            
            --node-bg: #1e293b;
            --node-border: #94a3b8;
            
            /* Memory Dark */
            --mem-bg: #334155;
            --mem-cell-border: #64748b;
            --mem-active: #065f46;
            --mem-head: #6b21a8;
            --mem-new: #854d0e;
            --mem-txt: #f1f5f9;
            
            --arrow-color: #f1f5f9;
            --pointer-txt: #f87171;
            
            --btn-white-bg: #1e293b;
            --btn-white-text: #f1f5f9;
            --btn-white-border: #475569;
            
            --code-kw: #60a5fa;
            --code-sym: #f87171;
            --code-txt: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* HEADER */
        header {
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 5px 20px;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0; gap: 20px; transition: background-color 0.3s;
        }
        .header-title h1 { margin: 0; font-size: 1.1rem; }
        .controls-area { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; flex:1; }

        /* BUTTONS */
        button {
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem;
            transition: all 0.2s; white-space: nowrap; height: 36px; display: flex; align-items: center; gap:5px;
        }
        .btn-white { background-color: var(--btn-white-bg); color: var(--btn-white-text); border: 1px solid var(--btn-white-border); }
        .btn-white:hover { filter: brightness(0.95); }
        .btn-blue { background-color: var(--btn-blue); color: white; border: 1px solid var(--btn-blue); }
        .btn-blue:hover { background-color: var(--btn-blue-hover); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .icon { font-size: 1.1em; }

        /* SLIDER */
        .slider-group {
            display: flex; align-items: center; gap: 8px;
            background: var(--btn-white-bg); padding: 4px 8px;
            border: 1px solid var(--btn-white-border); border-radius: 4px; height: 36px;
            color: var(--text-color); font-size: 0.85rem;
        }
        input[type=range] { width: 90px; cursor: pointer; }

        /* LAYOUT */
        .main-container {
            display: flex; flex: 1; padding: 10px; gap: 10px; height: calc(100% - 60px); box-sizing: border-box;
        }

        /* LEFT: CODE */
        .col-left {
            flex: 0 0 380px; display: flex; flex-direction: column; gap: 10px; overflow: hidden;
            transition: width 0.3s ease;
        }
        .col-left.hidden { width: 0; flex: 0 0 0; padding: 0; }
        
        .col-code {
            flex: 1; display: flex; flex-direction: column;
            background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .code-content {
            flex: 1; overflow-y: auto; padding: 10px;
            font-family: 'Consolas', monospace; font-size: 0.85rem; line-height: 1.4;
            background-color: var(--panel-bg); color: var(--code-txt);
        }
        .code-line { padding: 2px 6px; border-radius: 3px; white-space: pre-wrap; line-height: 1.6; margin-bottom: 8px;}
        .code-line.active { background-color: var(--highlight-line); font-weight: bold; color: var(--text-color); }
        .kw { color: var(--code-kw); font-weight: bold; }
        .sym { color: var(--code-sym); font-weight: bold; }
        .txt { color: var(--code-txt); }

        /* CENTER: VIZ (Grows to take available space) */
        .col-viz {
            flex: 1; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 10px; position: relative; overflow: hidden;
        }
        
        .scenario-box {
            font-weight: bold; color: var(--btn-blue); margin-bottom: 5px; font-size: 0.95rem;
        }

        .narrative {
            padding: 8px; margin-bottom: 10px;
            background: rgba(59, 130, 246, 0.15); border-left: 4px solid var(--btn-blue);
            font-size: 0.9rem; min-height: 24px; border-radius: 4px; color: var(--text-color);
        }
        
        .viz-content {
            flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; overflow: auto;
        }

        /* MEMORY GRID */
        .memory-wrapper {
            width: 100%; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center;
        }
        .mem-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; opacity: 0.8; }
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(3, auto);
            gap: 4px;
            background: var(--border-color);
            padding: 4px; border-radius: 6px;
            width: 100%; max-width: 950px; 
        }
        .mem-cell {
            background: var(--mem-bg); color: var(--mem-txt);
            font-family: monospace; 
            border-radius: 3px; border: 1px solid var(--mem-cell-border);
            display: flex; flex-direction: column; justify-content: space-between;
            height: 55px;
            padding: 2px;
            position: relative;
            transition: all 0.3s;
            /*overflow: hidden;*/
        }
        .mem-addr { font-size: 0.6rem; opacity: 0.7; text-align: left; letter-spacing: -0.5px; }
        
        .mem-content { 
            font-size: 0.65rem; 
            font-weight: bold; text-align: center;
            display: flex; justify-content: center; align-items: center;
            height: 100%; 
            white-space: nowrap; 
            overflow: hidden;
        }
        .mem-cell.active { background: var(--mem-active); border-color: #10b981; }
        .mem-cell.head { background: var(--mem-head); border-color: #8b5cf6; }
        .mem-cell.new { background: var(--mem-new); border-color: #f59e0b; }
        
        /* HEAD TAG - Bigger and more visible */
        /* HEAD TAG - Î”Î¹Î¿ÏÎ¸Ï‰Î¼Î­Î½Î¿ ÏƒÏ„Ï…Î» */
        .tag-head { 
            position: absolute; 
            top: -10px;        /* Î¤Î¿ Î±Î½ÎµÎ²Î¬Î¶Î¿Ï…Î¼Îµ Ï€Î¹Î¿ ÏˆÎ·Î»Î¬ Î³Î¹Î± Î½Î± ÎµÎ¾Î­Ï‡ÎµÎ¹ */
            right: -5px;       /* Î¤Î¿ Ï€Î¬Î¼Îµ Î»Î¯Î³Î¿ Î´ÎµÎ¾Î¹Î¬ */
            background: #8b5cf6; /* Î¤Î¿ Î¼Ï‰Î² Ï‡ÏÏÎ¼Î± Ï„Î·Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚ ÏƒÎ¿Ï… */
            color: white; 
            font-size: 0.7rem; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: bold; 
            z-index: 20;       /* Î“Î¹Î± Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ ÏŒÎ»Î± */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Î£ÎºÎ¹Î¬ Î³Î¹Î± Î½Î± Î¾ÎµÏ‡Ï‰ÏÎ¯Î¶ÎµÎ¹ */
            letter-spacing: 0.5px;
        }

        /* LIST VISUALIZATION */
        .list-area {
            position: relative; width: 100%; height: 400px; margin-top: 5px;
            overflow-x: auto; 
            overflow-y: hidden;
        }

        /* Node Styles */
        .node {
            position: absolute;
            width: 160px; height: 75px; 
            background: var(--node-bg);
            border: 2px solid var(--node-border);
            border-radius: 6px;
            display: flex; flex-direction: column;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            transition: all 0.8s ease-in-out;
            z-index: 2;
        }
        
        .node.head-box {
            width: 70px; height: 50px;
            background: var(--mem-head);
            border-color: #7c3aed;
            justify-content: center;
            z-index: 3;
        }
        .node.head-box .head-title { font-weight: bold; font-size: 0.85rem; color: #5b21b6; text-align: center; }
        .node.head-box .head-val { font-family: monospace; font-size: 0.75rem; text-align: center; color: #000; }

        .node-header {
            background: var(--border-color); font-size: 0.65rem; text-align: center; color: var(--text-color);
            padding: 1px; border-radius: 4px 4px 0 0; font-family: monospace; font-weight: bold;
        }
        
        .node-body { flex: 1; display: flex; overflow: hidden;}
        .node-data {
            flex: 1; display: flex; align-items: center; justify-content: center;
            border-right: 1px solid var(--node-border); font-weight: bold; 
            font-size: 0.8rem;
            padding: 2px 4px; text-align: center; 
            white-space: nowrap; 
            overflow: hidden;
        }
        .node-ptr {
            flex: 0.7; display: flex; align-items: center; justify-content: center;
            font-family: monospace; font-size: 0.7rem; color: var(--pointer-txt); flex-direction: column;
            overflow: hidden;
        }
        .ptr-label { font-size: 0.55rem; opacity: 0.7; color: var(--text-color); margin-bottom: 1px;}
        .node-tag {
            position: absolute; top: -20px; left: 0; width: 100%; text-align: center;
            font-weight: bold; color: var(--btn-blue); font-size: 0.8rem;
        }

        /* SVG Arrows */
        .svg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;
        }
        path {
            stroke: var(--arrow-color); stroke-width: 2; fill: none; transition: all 0.5s;
        }

        /* RIGHT: LOG - REDUCED WIDTH */
        .col-output {
            flex: 0 0 90px; /* Reduced to half of 180px */
            background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .output-header { padding: 5px; background: var(--bg-color); font-weight: bold; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; text-align: center;}
        .output-log { flex: 1; padding: 5px; overflow-y: auto; font-family: monospace; font-size: 0.75rem; background: var(--panel-bg); color: var(--text-color); }
        .log-item { border-bottom: 1px solid var(--border-color); padding: 2px 0; }

        .speak-btn.active { color: #ef4444; border-color: #ef4444; }

    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1>Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î±Ï€Î»Î¬ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î·Ï‚ Î»Î¯ÏƒÏ„Î±Ï‚. Î— Î±Î½Î±Ï€Î±ÏÎ¬ÏƒÏ„Î±ÏƒÎ· Ï„Î·Ï‚ Î¼Î½Î®Î¼Î·Ï‚ Î³Î¯Î½ÎµÏ„Î±Î¹ Î¼Îµ Ï„Ï…Ï‡Î±Î¯ÎµÏ‚ Î¸Î­ÏƒÎµÎ¹Ï‚ Î¼Î½Î®Î¼Î·Ï‚</h1>
    </div>
    
    <div class="controls-area">
        <button style="display:none;" class="btn btn-white speak-btn" id="btnSpeak" onclick="toggleSpeech()" title="Î‘Ï†Î®Î³Î·ÏƒÎ·">
            <span class="icon">ğŸ”‡</span>
        </button>

        <button class="btn btn-white" onclick="resetSim()">
            <span class="icon">ğŸ”„</span> Î‘ÏÏ‡Î®
        </button>
        
        <button class="btn btn-blue" id="btnPlay" onclick="play()">
            <span class="icon">â–¶</span> Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î•ÎºÏ„Î­Î»ÎµÏƒÎ·
        </button>
        
        <button class="btn btn-white" id="btnStep" onclick="step()">
            Î’Î®Î¼Î± <span class="icon">â©</span>
        </button>
        
        <button class="btn btn-white" id="btnCode" onclick="toggleCode()">
            <span class="icon">ğŸ‘</span> ÎšÏÎ´Î¹ÎºÎ±Ï‚
        </button>

        <div class="slider-group">
            <span>Î¤Î±Ï‡ÏÏ„Î·Ï„Î±:</span>
            <input type="range" min="100" max="2000" value="1000" id="speedSlider" oninput="updateSpeed()">
        </div>

        <button class="btn btn-white" onclick="toggleTheme()" title="Î˜Î­Î¼Î±">
            <span class="icon">ğŸŒ™</span>
        </button>
    </div>
</header>

<div class="main-container">
    
    <div class="col-left">
        <div class="col-code">
            <div class="code-content" id="codeContainer"></div>
        </div>
    </div>

    <div class="col-viz">
        <div id="scenarioBox" class="scenario-box"></div>
        
        <div class="narrative" id="narrativeBox">Î Î±Ï„Î®ÏƒÏ„Îµ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·...</div>
        
        <div class="viz-content">
            <div class="memory-wrapper">
                <div class="mem-label">ÎœÎ½Î®Î¼Î· Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®</div>
                <div class="memory-grid" id="memGrid">
                    </div>
            </div>

            <div class="list-area" id="listArea">
                <svg class="svg-layer" id="svgLayer">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--arrow-color)" />
                        </marker>
                    </defs>
                    </svg>
                </div>
        </div>
    </div>

    <div class="col-output">
        <div class="output-header">ÎŸÎ¸ÏŒÎ½Î·</div>
        <div class="output-log" id="outputLog"></div>
    </div>

</div>

<script>
    // --- Configuration ---
    const CODE_LINES = [
        "1. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Î­Î½Î±Î½ Î½Î­Î¿ ÎºÏŒÎ¼Î²Î¿ ÏƒÏ„Î· Î¼Î½Î®Î¼Î·.",
        "2. Î‘Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Ï…Î¼Îµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… Î¸Î­Î»Î¿Ï…Î¼Îµ ÏƒÏ„Î¿Î½ Î½Î­Î¿ ÎºÏŒÎ¼Î²Î¿.",
        "3. ÎŸ Î´ÎµÎ¯ÎºÏ„Î·Ï‚ Ï„Î¿Ï… Î½Î­Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï… ÏÏ…Î¸Î¼Î¯Î¶ÎµÏ„Î±Î¹ ÏÏƒÏ„Îµ Î½Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ ÎºÏŒÎ¼Î²Î¿ Ï€Î¿Ï… Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÏƒÎµ Ï„Î¿Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿.",
        "4. ÎŸ Î´ÎµÎ¯ÎºÏ„Î·Ï‚ Ï„Î¿Ï… Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï… Î±Î»Î»Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï€Î»Î­Î¿Î½ ÏƒÏ„Î¿Î½ Î½Î­Î¿ ÎºÏŒÎ¼Î²Î¿.",
        "5. Î— Î»Î¯ÏƒÏ„Î± ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î¬ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î· ÎºÎ±Î¹ Î· ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ½ÎµÏ„Î±Î¹."
    ];

    function kw(t) { return `<span class="kw">${t}</span>`; }
    function sym(t) { return `<span class="sym">${t}</span>`; }
    function txt(t) { return `<span class="txt">${t}</span>`; }

    // --- Content Themes ---
    const THEMES = [
        { type: 'nums', name: 'Î‘ÏÎ¹Î¸Î¼Î¿Î¯' },
        { type: 'chars', name: 'Î“ÏÎ¬Î¼Î¼Î±Ï„Î±' },
        { type: 'names', name: 'ÎŸÎ½ÏŒÎ¼Î±Ï„Î±', pool: ['Î“Î¹ÏÏÎ³Î¿Ï‚', 'ÎœÎ±ÏÎ¯Î±', 'ÎÎ¯ÎºÎ¿Ï‚', 'Î•Î»Î­Î½Î·', 'Î”Î·Î¼Î®Ï„ÏÎ·Ï‚', 'Î†Î½Î½Î±', 'ÎšÏÏƒÏ„Î±Ï‚', 'Î£Î¿Ï†Î¯Î±'] },
        { type: 'trip_gr', name: 'Î¤Î±Î¾Î¯Î´Î¹ Î•Î»Î»Î¬Î´Î±', path: ['Î›Î¬ÏÎ¹ÏƒÎ±', 'Î’ÏŒÎ»Î¿Ï‚', 'Î›Î±Î¼Î¯Î±', 'Î›ÎµÎ¹Î²Î±Î´Î¹Î¬', 'Î‘Î¸Î®Î½Î±', 'ÎÎ±ÏÏ€Î»Î¹Î¿', 'Î Î¬Ï„ÏÎ±', 'Î¤ÏÎ¯Ï€Î¿Î»Î·'] },
        { type: 'trip_eu', name: 'Î¤Î±Î¾Î¯Î´Î¹ Î•Ï…ÏÏÏ€Î·', path: ['Î Î¿ÏÏ„Î¿Î³Î±Î»Î¯Î±', 'Î™ÏƒÏ€Î±Î½Î¯Î±', 'Î“Î±Î»Î»Î¯Î±', 'Î“ÎµÏÎ¼Î±Î½Î¯Î±', 'Î Î¿Î»Ï‰Î½Î¯Î±', 'Î’Î­Î»Î³Î¹Î¿', 'ÎŸÎ»Î»Î±Î½Î´Î¯Î±'] }
    ];

    // --- State ---
    let steps = [];
    let stepIdx = -1;
    let timer = null;
    let isPlaying = false;
    let isAnimating = false;
    let speed = 2500;
    let memBaseAddr = 1000;
    let memSlots = [];
    let nodes = [];
    let headNodeViz = {};
    let speechEnabled = false;
    let currentTheme = null;

    // --- Initialization ---
    function init() {
        renderCode();
        resetSim();
        updateSpeed();
    }

    function renderCode() {
        document.getElementById('codeContainer').innerHTML = CODE_LINES.map((l, i) => 
            `<div class="code-line" id="line-${i}">${l}</div>`
        ).join('');
    }

    // --- Content Logic ---
    function generateContent() {
        // Pick Random Theme
        const theme = THEMES[Math.floor(Math.random() * THEMES.length)];
        let items = [];
        let insertItem = '';
        let splitIdx = 0; // Where to insert (1, 2, or 3)

        if (theme.type === 'nums') {
            for(let i=0; i<4; i++) items.push(Math.floor(Math.random()*100));
            insertItem = items.pop();
            splitIdx = Math.floor(Math.random() * 3) + 1;
        } 
        else if (theme.type === 'chars') {
            const alphabet = "ABCDEFGHJKLMNOPQRSTUVWXYZ";
            for(let i=0; i<4; i++) items.push(alphabet.charAt(Math.floor(Math.random() * alphabet.length)));
            insertItem = items.pop();
            splitIdx = Math.floor(Math.random() * 3) + 1;
        }
        else if (theme.type === 'names') {
            let pool = [...theme.pool];
            pool.sort(() => Math.random() - 0.5);
            items = pool.slice(0, 3);
            insertItem = pool[3];
            splitIdx = Math.floor(Math.random() * 3) + 1;
        }
        else if (theme.type.startsWith('trip')) {
            const maxStart = theme.path.length - 4;
            const startIdx = Math.floor(Math.random() * (maxStart + 1));
            const fullSeq = theme.path.slice(startIdx, startIdx + 4); 
            
            const removeRelative = Math.floor(Math.random() * 2) + 1; // 1 or 2
            
            insertItem = fullSeq[removeRelative];
            items = fullSeq.filter((_, i) => i !== removeRelative);
            
            splitIdx = removeRelative;
        }

        return { items, insertItem, splitIdx, themeName: theme.name };
    }

    // --- Memory Logic ---
    function initMemoryGrid() {
        memSlots = Array.from({length: 30}, (_, i) => ({
            addr: memBaseAddr + (i*4),
            val: '0',
            type: 'empty'
        }));
    }

    function assignRandomSlots() {
        let indices = Array.from({length: 30}, (_, i) => i);
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        return { 
            headIdx: indices[0], 
            n1Idx: indices[1], n2Idx: indices[2], n3Idx: indices[3], n4Idx: indices[4],
            newIdx: indices[5] 
        };
    }

    function renderMemoryGrid() {
        const grid = document.getElementById('memGrid');
        grid.innerHTML = '';
        
        memSlots.forEach((slot) => {
            const cell = document.createElement('div');
            cell.className = `mem-cell ${slot.type}`;
            cell.id = `mem-${slot.addr}`;
            
            let contentHtml = `<span class="mem-content">${slot.val}</span>`;
            if (slot.type === 'head') {
                contentHtml += `<div class="tag-head">HEAD</div>`;
            }

            cell.innerHTML = `
                <div class="mem-addr">${slot.addr}</div>
                ${contentHtml}
            `;
            grid.appendChild(cell);
        });
        
        const isDark = document.body.classList.contains('dark-mode');
        const arrowColor = isDark ? '#f1f5f9' : '#334155';
        const poly = document.querySelector('#arrowhead polygon');
        if(poly) poly.setAttribute('fill', arrowColor);
    }

    function updateMemoryCell(addr, val, type) {
        const idx = memSlots.findIndex(s => s.addr === addr);
        if (idx !== -1) {
            memSlots[idx].val = val;
            if (type) memSlots[idx].type = type;
            renderMemoryGrid();
            
            const cell = document.getElementById(`mem-${addr}`);
            if(cell) {
                cell.style.transition = 'transform 0.2s';
                cell.style.transform = 'scale(1.15)';
                setTimeout(() => cell.style.transform = 'scale(1)', 200);
            }
        }
    }

    // --- Core Logic ---
    function resetSim() {
        isPlaying = false;
        isAnimating = false;
        clearTimeout(timer);
        stepIdx = -1;
        
        document.getElementById('btnPlay').innerHTML = '<span class="icon">â–¶</span> Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î•ÎºÏ„Î­Î»ÎµÏƒÎ·';
        document.getElementById('narrativeBox').innerText = "Î Î±Ï„Î®ÏƒÏ„Îµ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·...";
        document.getElementById('outputLog').innerHTML = '';
        
        memBaseAddr = Math.floor(Math.random() * 5000) + 1000;
        initMemoryGrid();
        
        // Generate Content
        const content = generateContent();
        const { items, insertItem, splitIdx, themeName } = content;
        
        // Setup Memory Locations
        const locs = assignRandomSlots();
        const headPtrAddr = memSlots[locs.headIdx].addr;
        const addr1 = memSlots[locs.n1Idx].addr;
        const addr2 = memSlots[locs.n2Idx].addr;
        const addr3 = memSlots[locs.n3Idx].addr;
        const addrNew = memSlots[locs.newIdx].addr;

        // Populate Memory
        memSlots[locs.headIdx] = { ...memSlots[locs.headIdx], val: addr1, type: 'head' };
        memSlots[locs.n1Idx] = { ...memSlots[locs.n1Idx], val: `[${items[0]}|${addr2}]`, type: 'active' };
        memSlots[locs.n2Idx] = { ...memSlots[locs.n2Idx], val: `[${items[1]}|${addr3}]`, type: 'active' };
        memSlots[locs.n3Idx] = { ...memSlots[locs.n3Idx], val: `[${items[2]}|NULL]`, type: 'active' };
        
        renderMemoryGrid();

        // Scenario Text Logic (By Position)
        const title = document.getElementById('scenarioBox');
        title.innerText = `Î£ÎµÎ½Î¬ÏÎ¹Î¿ (${themeName}): Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Ï„Î¿Ï… '${insertItem}' Î¼ÎµÏ„Î±Î¾Ï Ï„Î¿Ï… ${splitIdx}Î¿Ï… ÎºÎ±Î¹ ${splitIdx+1}Î¿Ï… ÎºÏŒÎ¼Î²Î¿Ï…`;

        // Viz Setup
        // HEAD Box Position
        headNodeViz = { id: 'headViz', x: 20, y: 130, val: addr1, nextAddr: addr1, addr: headPtrAddr, type: 'head' };

        // Compact Gap = 220px. Start X = 170px to leave space for arrow
        const gap = 220; 
        const startX = 170; 
        
        let n1 = { id: 'n1', x: startX, y: 130, val: items[0], nextAddr: addr2, addr: addr1, label: '' };
        let n2 = { id: 'n2', x: startX + gap, y: 130, val: items[1], nextAddr: addr3, addr: addr2, label: '' };
        let n3 = { id: 'n3', x: startX + gap*2, y: 130, val: items[2], nextAddr: 'NULL', addr: addr3, label: '' };
        
        nodes = [n1, n2, n3];

        // Label "Current"
        nodes[splitIdx-1].label = "Î¤ÏÎ­Ï‡Ï‰Î½";

        const nextNodeAddr = nodes[splitIdx-1].nextAddr;

        renderNodes(false);
        highlightLine(-1);
        calcSteps(addrNew, nextNodeAddr, insertItem, splitIdx);
    }

    function calcSteps(newAddr, nextAddr, insertVal, splitIdx) {
        const gap = 220; 
        const startX = 170;
        const currentX = startX + (splitIdx-1)*gap;
        
        // Center new node in the gap below
        const newX = currentX + (gap/2) - 80; // 160 width / 2

        steps = [
            {
                line: 0,
                msg: "Î”Î­ÏƒÎ¼ÎµÏ…ÏƒÎ· Ï‡ÏÏÎ¿Ï… ÏƒÏ„Î· Î¼Î½Î®Î¼Î· Î³Î¹Î± Ï„Î¿Î½ ÎºÏŒÎ¼Î²Î¿ 'ÎÎ­Î¿Ï‚'.",
                action: () => {
                    updateMemoryCell(newAddr, `[ ? | ? ]`, 'new');
                    nodes.push({ id: 'nNew', x: newX, y: 260, val: '?', nextAddr: '?', addr: newAddr, label: 'ÎÎ­Î¿Ï‚' });
                    renderNodes();
                }
            },
            {
                line: 1,
                msg: `Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ '${insertVal}' ÏƒÏ„Î¿ Ï€ÎµÎ´Î¯Î¿ Ï„Î¹Î¼Î®Ï‚.`,
                action: () => {
                    const n = nodes.find(x => x.id === 'nNew');
                    n.val = insertVal;
                    updateMemoryCell(newAddr, `[${insertVal}| ? ]`, 'new');
                    renderNodes();
                }
            },
            {
                line: 2,
                msg: "ÎŸ Î´ÎµÎ¯ÎºÏ„Î·Ï‚ Ï„Î¿Ï… 'ÎÎ­Î¿Ï…' Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ (Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· " + nextAddr + ").",
                action: () => {
                    const n = nodes.find(x => x.id === 'nNew');
                    n.nextAddr = nextAddr;
                    updateMemoryCell(newAddr, `[${insertVal}|${nextAddr}]`, 'new');
                    renderNodes();
                    drawLines();
                }
            },
            {
                line: 3,
                msg: "ÎŸ Î´ÎµÎ¯ÎºÏ„Î·Ï‚ Ï„Î¿Ï… 'Î¤ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚' Î±Î»Î»Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ 'ÎÎ­Î¿' (" + newAddr + ").",
                action: () => {
                    const curr = nodes[splitIdx-1]; 
                    curr.nextAddr = newAddr;
                    updateMemoryCell(curr.addr, `[${curr.val}|${newAddr}]`, 'active');
                    renderNodes();
                    drawLines();
                }
            },
            {
                line: 4,
                msg: "Î— ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ.",
                action: () => {
                    // Re-align visually
                    const nNew = nodes.find(x => x.id === 'nNew');
                    nNew.y = 130;
                    nNew.x = startX + (splitIdx)*gap; 
                    
                    // Shift subsequent
                    for(let i=splitIdx; i<nodes.length-1; i++) {
                        nodes[i].x += gap;
                    }
                    
                    updateMemoryCell(newAddr, `[${insertVal}|${nextAddr}]`, 'active');
                    renderNodes();
                    drawLines();
                }
            }
        ];
    }

    function renderNodes() {
        const area = document.getElementById('listArea');
        document.querySelectorAll('.node').forEach(e => e.remove());
        
        const headDiv = document.createElement('div');
        headDiv.className = 'node head-box';
        headDiv.id = 'headViz';
        headDiv.style.left = headNodeViz.x + 'px';
        headDiv.style.top = headNodeViz.y + 'px';
        headDiv.innerHTML = `
            <div class="head-title">HEAD</div>
            <div class="head-val">${headNodeViz.val}</div>
        `;
        area.appendChild(headDiv);

        nodes.forEach(n => {
            const div = document.createElement('div');
            div.className = 'node';
            div.id = n.id;
            div.style.left = n.x + 'px';
            div.style.top = n.y + 'px';
            div.innerHTML = `
                ${n.label ? `<div class="node-tag">${n.label}</div>` : ''}
                <div class="node-header">${n.addr}</div>
                <div class="node-body">
                    <div class="node-data" title="${n.val}">${n.val}</div>
                    <div class="node-ptr">
                        <span class="ptr-label">Next</span>
                        ${n.nextAddr}
                    </div>
                </div>
            `;
            area.appendChild(div);
        });
        
        drawLines();
    }

    function drawLines() {
        const svg = document.getElementById('svgLayer');
        const oldLines = svg.querySelectorAll('path');
        oldLines.forEach(l => l.remove());

        const firstNode = nodes[0];
        if(firstNode) {
            connectNodes({x: headNodeViz.x, y: headNodeViz.y, width: 70}, firstNode);
        }

        nodes.forEach(source => {
            if(source.nextAddr === 'NULL' || source.nextAddr === '?') return;
            const target = nodes.find(n => n.addr === source.nextAddr);
            if(target) connectNodes(source, target);
        });
    }

    function connectNodes(n1, n2) {
        const svg = document.getElementById('svgLayer');
        
        const width = n1.width || 160; 
        const x1 = n1.x + width; 
        const y1 = n1.y + 37; // Center of 75px height
        const x2 = n2.x - 5;      
        const y2 = n2.y + 37;

        const path = document.createElementNS("http://www.w3.org/2000/svg", 'path');
        
        if (Math.abs(y1 - y2) < 20) {
            path.setAttribute('d', `M${x1},${y1} L${x2},${y2}`);
        } else {
            path.setAttribute('d', `M${x1},${y1} C${x1+40},${y1} ${x2-40},${y2} ${x2},${y2}`);
        }
        
        path.setAttribute('marker-end', 'url(#arrowhead)');
        svg.appendChild(path);
    }

    function highlightLine(idx) {
        document.querySelectorAll('.code-line').forEach(l => l.classList.remove('active'));
        if(idx >= 0) document.getElementById(`line-${idx}`).classList.add('active');
    }

    function step() {
        if(isAnimating) return;
        if(stepIdx >= steps.length - 1) return;

        stepIdx++;
        const s = steps[stepIdx];
        
        highlightLine(s.line);
        document.getElementById('narrativeBox').innerText = s.msg;
        speak(s.msg);

        if(s.action) s.action();

        if(stepIdx === steps.length - 1) {
            isPlaying = false;
            document.getElementById('btnPlay').innerHTML = '<span class="icon">â–¶</span> Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·';
        } else if(isPlaying) {
            isAnimating = true;
            timer = setTimeout(() => {
                isAnimating = false;
                step();
            }, speed);
        }
    }

    function play() {
        const btn = document.getElementById('btnPlay');
        if(!isPlaying) {
            if(stepIdx >= steps.length - 1) resetSim();
            isPlaying = true;
            btn.innerHTML = '<span class="icon">â¸</span> Î Î±ÏÏƒÎ·';
            step();
        } else {
            isPlaying = false;
            clearTimeout(timer);
            isAnimating = false;
            btn.innerHTML = '<span class="icon">â–¶</span> Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î•ÎºÏ„Î­Î»ÎµÏƒÎ·';
        }
    }

    function toggleCode() {
        document.querySelector('.col-left').classList.toggle('hidden');
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        const arrowColor = isDark ? '#f1f5f9' : '#334155';
        const poly = document.querySelector('#arrowhead polygon');
        if(poly) poly.setAttribute('fill', arrowColor);
    }

    function updateSpeed() {
        speed = 3500 - document.getElementById('speedSlider').value;
    }

    function toggleSpeech() {
        speechEnabled = !speechEnabled;
        const btn = document.getElementById('btnSpeak');
        if(speechEnabled) {
            btn.innerHTML = '<span class="icon">ğŸ”ˆ</span>';
            btn.classList.add('active');
        } else {
            btn.innerHTML = '<span class="icon">ğŸ”‡</span>';
            btn.classList.remove('active');
            window.speechSynthesis.cancel();
        }
    }

    function speak(text) {
        if(!speechEnabled) return;
        window.speechSynthesis.cancel(); 
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'el-GR';
        window.speechSynthesis.speak(utter);
    }

    init();

</script>
</body>
</html>