<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î Ï‰Î»Î®ÏƒÎµÎ¹Ï‚ Î¤ÏÎ¹Î¼Î®Î½Ï‰Î½</title>
    <style>
        :root {
            /* Light Mode Variables */
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --panel-bg: #ffffff;
            --highlight-line: #fde047;
            --header-bg: #e2e8f0;
            --border-color: #cbd5e1;
            
            --var-main: #3b82f6; 
            --sales-color: #059669; 
            --sum-color: #d97706; 
            
            /* Quarter Colors */
            --q1-color: #dbeafe; 
            --q2-color: #dcfce7; 
            --q3-color: #fef9c3; 
            --q4-color: #fce7f3; 
            
            --cell-bg: #fff;
            --cell-active-read: #facc15;
            --cell-active-write: #fb923c;
            
            --disabled-btn: #94a3b8;
            
            /* Button Colors Light */
            --btn-white-bg: #ffffff;
            --btn-white-text: #1e293b;
            --btn-white-border: #cbd5e1;
            
            /* Code Highlight Light */
            --code-kw: #0000CD;
            --code-sym: #FF0000;
            --code-txt: #000000;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --panel-bg: #1e293b;
            --highlight-line: #334155;
            --border-color: #334155;
            
            --cell-bg: #1e293b;
            --cell-active-read: #ca8a04; /* Darker yellow */
            
            /* Button Colors Dark */
            --btn-white-bg: #1e293b;
            --btn-white-text: #f1f5f9;
            --btn-white-border: #475569;
            
            /* Code Highlight Dark */
            --code-kw: #60a5fa;
            --code-sym: #f87171;
            --code-txt: #e2e8f0;
            
            /* Adjust Quarter Colors for Dark Mode (optional, keeping them visible) */
            --q1-color: #1e3a8a; 
            --q2-color: #064e3b; 
            --q3-color: #854d0e; 
            --q4-color: #831843; 
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            box-sizing: border-box;
            flex-shrink: 0;
            z-index: 100;
            transition: background-color 0.3s;
        }

        .header-title h1 { margin: 0; font-size: 1.1rem; }
        .controls-area { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

        button {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        button.primary { background-color: var(--var-main); color: white; border: none; }
        button.primary:hover:not(:disabled) { filter: brightness(0.95); transform: translateY(-1px); }
        
        /* White Button Style (Adapts to Dark Mode) */
        button.btn-white, .sol-btn {
            background-color: var(--btn-white-bg);
            color: var(--btn-white-text);
            border: 1px solid var(--btn-white-border);
        }
        button.btn-white:hover, .sol-btn:hover {
            filter: brightness(0.95);
        }

        button:disabled { background-color: var(--disabled-btn); color: #ccc; cursor: not-allowed; transform: none; }
        
        /* Specific Styles for Solution Buttons */
        .sol-btn { 
            width: 100%; 
            text-align: left; 
            font-size: 0.85rem;
            margin-bottom: 0;
            transform: none !important; 
        }
        .sol-btn.active { 
            background-color: #e0f2fe; 
            border-color: var(--var-main); 
            color: var(--var-main); 
            font-weight: bold; 
        }
        /* Active button in dark mode */
        body.dark-mode .sol-btn.active {
            background-color: #1e40af;
            color: #fff;
            border-color: #60a5fa;
        }
        .sol-btn.locked {
            cursor: default;
        }

        .slider-container { 
            display: flex; align-items: center; gap: 5px; font-size: 0.8rem; margin-left: 10px; 
            background: var(--btn-white-bg);
            padding: 4px 8px;
            border: 1px solid var(--btn-white-border);
            border-radius: 4px;
            color: var(--text-color);
        }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            padding: 15px;
            gap: 15px;
            height: calc(100% - 60px);
            box-sizing: border-box;
            overflow: hidden; 
        }

        /* LEFT COLUMN */
        .col-left {
            flex: 0 0 420px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .solutions-panel {
            background: var(--panel-bg);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column; 
            gap: 5px;
        }
        
        .solutions-label { 
            font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display:block; color: var(--text-color); opacity: 0.8;
        }

        .col-code {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
        }

        .code-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem; 
            line-height: 1.3;   
            background-color: var(--panel-bg);
            color: var(--text-color);
        }
        
        .code-line { 
            display: flex;
            align-items: center;
            padding: 1px 4px; 
            margin: 0;
            border-radius: 2px;
        }
        .code-line.active { background-color: var(--highlight-line); font-weight: bold; color: var(--text-color); }

        .line-num {
            color: #94a3b8;
            width: 25px;
            text-align: right;
            margin-right: 10px;
            padding-right: 5px;
            border-right: 1px solid var(--border-color);
            font-size: 0.8rem;
            user-select: none;
        }

        /* CENTER: Visualization */
        .col-viz {
            flex: 1;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        .narrative {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(59, 130, 246, 0.15);
            border-left: 4px solid var(--var-main);
            font-size: 0.9rem;
            font-style: italic;
            min-height: 24px;
            flex-shrink: 0;
            border-radius: 4px;
            color: var(--text-color);
        }

        .viz-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            gap: 20px; 
            padding-top: 40px; 
        }

        /* Arrays */
        .array-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--bg-color); /* Matches page bg inside viz */
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .array-label { 
            font-weight: bold; 
            margin-bottom: 40px; 
            font-size: 1.1rem; 
            color: var(--text-color);
        }
        
        .array-cells {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        .cell {
            width: 45px;
            height: 45px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--cell-bg);
            border: 2px solid #ccc;
            border-radius: 6px;
            font-weight: bold;
            position: relative;
            transition: all 0.3s ease;
            color: var(--text-color);
        }
        
        .cell.sales { border-color: var(--sales-color); color: var(--sales-color); }
        .cell.sum { border-color: var(--sum-color); color: var(--sum-color); }
        /* Override specific text colors in dark mode if needed for readability */
        body.dark-mode .cell.sales { color: #34d399; }
        body.dark-mode .cell.sum { color: #fbbf24; }

        .cell.reading {
            background-color: var(--cell-active-read);
            transform: scale(1.15);
            border-color: #000;
            z-index: 10;
            color: #000; /* Keep text black on highlight */
        }
        .cell.writing {
            background-color: var(--cell-active-write);
            transform: scale(1.2);
            border-color: #000;
            z-index: 10;
            color: white; /* Keep text white on write highlight */
        }

        .cell.q1 { background-color: var(--q1-color); color: #000; }
        .cell.q2 { background-color: var(--q2-color); color: #000; }
        .cell.q3 { background-color: var(--q3-color); color: #000; }
        .cell.q4 { background-color: var(--q4-color); color: #000; }
        
        /* Ensure text is readable in dark mode quarters */
        body.dark-mode .cell.q1, 
        body.dark-mode .cell.q2, 
        body.dark-mode .cell.q3, 
        body.dark-mode .cell.q4 { color: #fff; }

        .cell-index {
            position: absolute;
            top: -18px;
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
            font-weight: normal;
        }

        /* Vertical Layout Compact */
        .viz-content.vertical {
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 30px; 
            padding-top: 10px;
        }
        
        .viz-content.vertical .array-container {
            width: auto;
            padding: 10px; 
        }

        .viz-content.vertical .array-cells {
            flex-direction: column;
            gap: 2px;
        }
        
        .viz-content.vertical .cell {
            width: 40px;
            height: 30px;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .viz-content.vertical .array-label {
            margin-bottom: 20px; 
        }
        
        .viz-content.vertical .cell-index {
            top: auto;
            left: -22px; 
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 0.7rem;
        }

        /* RIGHT: Output */
        .col-output {
            flex: 0 0 220px;
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .output-header { padding: 10px; background: var(--bg-color); font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .output-log { flex: 1; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.95rem; background: var(--panel-bg); color: var(--text-color); }
        .log-item { border-bottom: 1px solid var(--border-color); padding: 3px 0; }
        
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1>Î Î©Î›[12]: ÎœÎ·Î½Î¹Î±Î¯ÎµÏ‚ Ï€Ï‰Î»Î®ÏƒÎµÎ¹Ï‚. Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÏƒÏ…Î½Î¿Î»Î¹ÎºÏÎ½ Ï€Ï‰Î»Î®ÏƒÎµÏ‰Î½ Ï„ÎµÏƒÏƒÎ¬ÏÏ‰Î½ Ï„ÏÎ¹Î¼Î®Î½Ï‰Î½ </h1>
    </div>
    
    <div class="controls-area">
        <button class="btn btn-white" id="btnOrient" onclick="toggleOrient()">ğŸ”„ ÎšÎ¬Î¸ÎµÏ„Î±</button>
        <button class="btn btn-white" onclick="resetSim()">ğŸ”„ Î‘ÏÏ‡Î®</button>
        <button onclick="play()" id="btnPlay" class="primary">â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ·</button>
        <button class="btn btn-white" onclick="step()" id="btnStep">Î’Î®Î¼Î± â©</button>
        
        <div class="slider-container">
            <span>Î¤Î±Ï‡ÏÏ„Î·Ï„Î±:</span>
            <input type="range" min="100" max="2000" value="1000" id="speedSlider" oninput="updateSpeed()">
        </div>

        <button class="btn btn-white" onclick="toggleTheme()" title="Î•Î½Î±Î»Î»Î±Î³Î® Î˜Î­Î¼Î±Ï„Î¿Ï‚">
            <span class="icon">ğŸŒ™</span>
        </button>
    </div>
</header>

<div class="main-container">
    
    <div class="col-left">
        <div class="solutions-panel">
            <span class="solutions-label">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î›ÏÏƒÎ·:</span>
            <button class="sol-btn active" id="btnSol1" onclick="loadSolution(1)">1. Î Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Î£Ï…Î½Î¸Î®ÎºÎµÏ‚ (Î‘Î½)</button>
            <button class="sol-btn" id="btnSol2" onclick="loadSolution(2)">2. Î Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Î•Ï€Î±Î½Î±Î»Î®ÏˆÎµÎ¹Ï‚</button>
            <button class="sol-btn" id="btnSol3" onclick="loadSolution(3)">3. Î“ÎµÎ½Î¹ÎºÎ® Î›ÏÏƒÎ· (Î•Î¼Ï†Ï‰Î»ÎµÏ…Î¼Î­Î½ÎµÏ‚)</button>
            <button class="sol-btn" id="btnSol4" onclick="loadSolution(4)">4. Î›ÏÏƒÎ· Î¼Îµ Î’Î®Î¼Î± 3</button>
        </div>

        <div class="col-code">
            <div class="code-content" id="codeContainer"></div>
        </div>
    </div>

    <div class="col-viz">
        <div class="narrative" id="narrativeBox">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î»ÏÏƒÎ· ÎºÎ±Î¹ Ï€Î±Ï„Î®ÏƒÏ„Îµ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·...</div>
        
        <div class="viz-content" id="vizContent">
            
            <div class="array-container">
                <div class="array-label">Î Î©Î›[12]</div>
                <div class="array-cells" id="salesCells"></div>
            </div>

            <div class="array-container">
                <div class="array-label">Î±Î¸Ï[4]</div>
                <div class="array-cells" id="sumCells"></div>
            </div>
        </div>
    </div>

    <div class="col-output">
        <div class="output-header">ğŸ“º ÎŸÎ¸ÏŒÎ½Î· Î•Î¾ÏŒÎ´Î¿Ï…</div>
        <div class="output-log" id="outputLog"></div>
    </div>

</div>

<script>
    // DATA
    const SALES = [100, 150, 200, 120, 130, 250, 90, 80, 100, 300, 400, 200];
    let SUMS = [0, 0, 0, 0];

    // SOLUTIONS DATA
    const SOLS = {
        1: {
            lines: [
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 1 Î¼Î­Ï‡ÏÎ¹ 4",
                "   Î±Î¸Ï[Î¹] â† 0",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚",
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 1 Î¼Î­Ï‡ÏÎ¹ 12",
                "   Î‘Î½ Î¹<=3 Ï„ÏŒÏ„Îµ",
                "      Î±Î¸Ï[1] â† Î±Î¸Ï[1] + Î Î©Î›[Î¹]",
                "   Î±Î»Î»Î¹ÏÏ‚_Î±Î½ Î¹<=6 Ï„ÏŒÏ„Îµ",
                "      Î±Î¸Ï[2] â† Î±Î¸Ï[2] + Î Î©Î›[Î¹]",
                "   Î±Î»Î»Î¹ÏÏ‚_Î±Î½ Î¹<=9 Ï„ÏŒÏ„Îµ",
                "      Î±Î¸Ï[3] â† Î±Î¸Ï[3] + Î Î©Î›[Î¹]",
                "   Î±Î»Î»Î¹ÏÏ‚",
                "      Î±Î¸Ï[4] â† Î±Î¸Ï[4] + Î Î©Î›[Î¹]",
                "   Î¤Î­Î»Î¿Ï‚_Î±Î½",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚"
            ]
        },
        2: {
            lines: [
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 1 Î¼Î­Ï‡ÏÎ¹ 4",
                "   Î±Î¸Ï[Î¹] â† 0",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚",
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 1 Î¼Î­Ï‡ÏÎ¹ 3",
                "   Î±Î¸Ï[1] â† Î±Î¸Ï[1] + Î Î©Î›[Î¹]",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚",
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 4 Î¼Î­Ï‡ÏÎ¹ 6",
                "   Î±Î¸Ï[2] â† Î±Î¸Ï[2] + Î Î©Î›[Î¹]",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚",
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 7 Î¼Î­Ï‡ÏÎ¹ 9",
                "   Î±Î¸Ï[3] â† Î±Î¸Ï[3] + Î Î©Î›[Î¹]",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚",
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 10 Î¼Î­Ï‡ÏÎ¹ 12",
                "   Î±Î¸Ï[4] â† Î±Î¸Ï[4] + Î Î©Î›[Î¹]",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚"
            ]
        },
        3: {
            lines: [
                "Î¿ÏÎ¹Î¿ â† 1",
                "Î“Î¹Î± Ï„Ï Î±Ï€ÏŒ 1 Î¼Î­Ï‡ÏÎ¹ 4",
                "   Î±Î¸Ï[Ï„Ï] â† 0",
                "   Î“Î¹Î± Î¾ Î±Ï€ÏŒ Î¿ÏÎ¹Î¿ Î¼Î­Ï‡ÏÎ¹ Î¿ÏÎ¹Î¿+2",
                "      Î±Î¸Ï[Ï„Ï] â† Î±Î¸Ï[Ï„Ï] + Î Î©Î›[Î¾]",
                "   Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚",
                "   Î“ÏÎ¬ÏˆÎµ Î±Î¸Ï[Ï„Ï]",
                "   Î¿ÏÎ¹Î¿ â† Î¿ÏÎ¹Î¿ + 3",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚"
            ]
        },
        4: {
            lines: [
                "Î“Î¹Î± Î¹ Î±Ï€ÏŒ 1 Î¼Î­Ï‡ÏÎ¹ 10 Î¼Îµ_Î²Î®Î¼Î± 3",
                "   Î±Î¸Ï â† Î Î©Î›[Î™] + Î Î©Î›[Î™+1] + Î Î©Î›[Î™+2]",
                "   Î“ÏÎ¬ÏˆÎµ Î±Î¸Ï",
                "Î¤Î­Î»Î¿Ï‚_ÎµÏ€Î±Î½Î¬Î»Î·ÏˆÎ·Ï‚"
            ]
        }
    };

    let currentSol = 1;
    let steps = [];
    let stepIdx = 0;
    let timer = null;
    let isPlaying = false;
    let isAnimating = false;
    let speed = 1100;
    let isVertical = false;

    function init() {
        renderArrays();
        loadSolution(1);
        updateSpeed();
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
    }

    function loadSolution(id) {
        if (isPlaying || isAnimating) return; // Prevent changing while playing

        currentSol = id;
        
        // Update Buttons UI - Manually handle classes to avoid conflicts
        document.querySelectorAll('.sol-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btnSol${id}`);
        if(btn) btn.classList.add('active');

        // Render Code
        const codeDiv = document.getElementById('codeContainer');
        codeDiv.innerHTML = SOLS[id].lines.map((l, i) => 
            `<div class="code-line" id="line-${i+1}">
                <span class="line-num">${i+1}</span>
                ${l.replace(/ /g, '&nbsp;')}
             </div>`
        ).join('');

        resetSim();
    }

    function renderArrays() {
        // Sales
        const sDiv = document.getElementById('salesCells');
        sDiv.innerHTML = '';
        SALES.forEach((v, i) => {
            sDiv.innerHTML += `<div class="cell sales" id="sale-${i+1}"><span class="cell-index">${i+1}</span>${v}</div>`;
        });

        // Sums
        const sumDiv = document.getElementById('sumCells');
        sumDiv.innerHTML = '';
        [0,0,0,0].forEach((v, i) => {
            sumDiv.innerHTML += `<div class="cell sum" id="sum-${i+1}"><span class="cell-index">${i+1}</span>${v}</div>`;
        });
    }

    function updateSumVal(idx, val) {
        if (idx > 4) return; 
        const el = document.getElementById(`sum-${idx}`);
        if(el) {
            el.innerHTML = `<span class="cell-index">${idx}</span>${val}`;
        }
    }

    function colorQuarter(quarterIdx) {
        let start = (quarterIdx - 1) * 3 + 1;
        let end = start + 2;
        for(let i=start; i<=end; i++) {
            const el = document.getElementById(`sale-${i}`);
            if(el) el.classList.add(`q${quarterIdx}`);
        }
        const sumEl = document.getElementById(`sum-${quarterIdx}`);
        if(sumEl) sumEl.classList.add(`q${quarterIdx}`);
    }

    function resetSim() {
        isPlaying = false;
        isAnimating = false;
        clearTimeout(timer);
        stepIdx = 0;
        SUMS = [0,0,0,0];
        
        // Reset Visuals
        for(let i=1; i<=4; i++) updateSumVal(i, 0);
        document.querySelectorAll('.cell').forEach(c => {
            c.classList.remove('active', 'reading', 'writing', 'q1', 'q2', 'q3', 'q4');
        });
        document.getElementById('outputLog').innerHTML = '';
        document.getElementById('btnPlay').innerText = "â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ·";
        toggleControls(true); // Ensure enabled

        generateSteps();
        
        if(steps.length > 0) {
            highlightLine(steps[0].line);
            document.getElementById('narrativeBox').innerText = "ÎˆÏ„Î¿Î¹Î¼Î¿. " + steps[0].msg;
        }
    }

    function highlightLine(idx) {
        document.querySelectorAll('.code-line').forEach(e => e.classList.remove('active'));
        const el = document.getElementById(`line-${idx}`);
        if(el) el.classList.add('active');
    }

    function animRead(idx) {
        const el = document.getElementById(`sale-${idx}`);
        if(el) el.classList.add('reading');
    }
    
    function animWrite(idx, val) {
        const el = document.getElementById(`sum-${idx}`);
        if(el) {
            el.classList.add('writing');
            el.innerHTML = `<span class="cell-index">${idx}</span>${val}`;
        }
    }

    function clearAnims() {
        document.querySelectorAll('.cell').forEach(c => {
            c.classList.remove('reading', 'writing');
        });
    }

    function logOutput(txt) {
        const log = document.getElementById('outputLog');
        log.innerHTML += `<div class="log-item">${txt}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function generateSteps() {
        steps = [];
        let s = SUMS.slice(); 

        if(currentSol === 1) {
            steps.push({line: 1, msg: "Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·"});
            for(let i=1; i<=4; i++) steps.push({line: 2, msg: `Î±Î¸Ï[${i}] <- 0`});
            
            for(let i=1; i<=12; i++) {
                steps.push({line: 4, msg: `Î“Î¹Î± Î¼Î®Î½Î± Î¹=${i}`});
                steps.push({line: 5, msg: `ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: ${i} <= 3`});
                if(i<=3) {
                    s[0] += SALES[i-1];
                    steps.push({line: 6, type: 'calc', sIdx: 1, pIdx: i, val: s[0], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
                    if(i==3) steps.push({line: 6, type: 'color', q: 1, msg: "Î¤Î­Î»Î¿Ï‚ 1Î¿Ï… Î¤ÏÎ¹Î¼Î®Î½Î¿Ï…"});
                } else {
                    steps.push({line: 7, msg: `ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: ${i} <= 6`});
                    if(i<=6) {
                        s[1] += SALES[i-1];
                        steps.push({line: 8, type: 'calc', sIdx: 2, pIdx: i, val: s[1], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
                        if(i==6) steps.push({line: 8, type: 'color', q: 2, msg: "Î¤Î­Î»Î¿Ï‚ 2Î¿Ï… Î¤ÏÎ¹Î¼Î®Î½Î¿Ï…"});
                    } else {
                        steps.push({line: 9, msg: `ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: ${i} <= 9`});
                        if(i<=9) {
                            s[2] += SALES[i-1];
                            steps.push({line: 10, type: 'calc', sIdx: 3, pIdx: i, val: s[2], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
                            if(i==9) steps.push({line: 10, type: 'color', q: 3, msg: "Î¤Î­Î»Î¿Ï‚ 3Î¿Ï… Î¤ÏÎ¹Î¼Î®Î½Î¿Ï…"});
                        } else {
                            steps.push({line: 11, msg: "Î‘Î»Î»Î¹ÏÏ‚..."});
                            s[3] += SALES[i-1];
                            steps.push({line: 12, type: 'calc', sIdx: 4, pIdx: i, val: s[3], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
                            if(i==12) steps.push({line: 12, type: 'color', q: 4, msg: "Î¤Î­Î»Î¿Ï‚ 4Î¿Ï… Î¤ÏÎ¹Î¼Î®Î½Î¿Ï…"});
                        }
                    }
                }
                steps.push({line: 13, msg: "Î¤Î­Î»Î¿Ï‚_Î±Î½"});
            }
        }
        else if(currentSol === 2) {
            steps.push({line: 1, msg: "Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·"});
            for(let i=1; i<=4; i++) steps.push({line: 2, msg: `Î±Î¸Ï[${i}] <- 0`});

            // Q1
            steps.push({line: 4, msg: "1Î¿ Î¤ÏÎ¯Î¼Î·Î½Î¿"});
            for(let i=1; i<=3; i++){
                s[0] += SALES[i-1];
                steps.push({line: 5, type: 'calc', sIdx: 1, pIdx: i, val: s[0], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
            }
            steps.push({line: 6, type: 'color', q: 1, msg: "Î¤Î­Î»Î¿Ï‚ 1Î¿Ï…"});

            // Q2
            steps.push({line: 7, msg: "2Î¿ Î¤ÏÎ¯Î¼Î·Î½Î¿"});
            for(let i=4; i<=6; i++){
                s[1] += SALES[i-1];
                steps.push({line: 8, type: 'calc', sIdx: 2, pIdx: i, val: s[1], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
            }
            steps.push({line: 9, type: 'color', q: 2, msg: "Î¤Î­Î»Î¿Ï‚ 2Î¿Ï…"});

            // Q3
            steps.push({line: 10, msg: "3Î¿ Î¤ÏÎ¯Î¼Î·Î½Î¿"});
            for(let i=7; i<=9; i++){
                s[2] += SALES[i-1];
                steps.push({line: 11, type: 'calc', sIdx: 3, pIdx: i, val: s[2], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
            }
            steps.push({line: 12, type: 'color', q: 3, msg: "Î¤Î­Î»Î¿Ï‚ 3Î¿Ï…"});

            // Q4
            steps.push({line: 13, msg: "4Î¿ Î¤ÏÎ¯Î¼Î·Î½Î¿"});
            for(let i=10; i<=12; i++){
                s[3] += SALES[i-1];
                steps.push({line: 14, type: 'calc', sIdx: 4, pIdx: i, val: s[3], msg: `Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î Î©Î›[${i}]`});
            }
            steps.push({line: 15, type: 'color', q: 4, msg: "Î¤Î­Î»Î¿Ï‚ 4Î¿Ï…"});
        }
        else if(currentSol === 3) {
            let limit = 1;
            steps.push({line: 1, msg: "Î¿ÏÎ¹Î¿ <- 1"});
            
            for(let tr=1; tr<=4; tr++) {
                steps.push({line: 2, msg: `Î“Î¹Î± Ï„ÏÎ¯Î¼Î·Î½Î¿ ${tr}`});
                steps.push({line: 3, msg: `Î±Î¸Ï[${tr}] <- 0`});
                
                for(let xi=limit; xi<=limit+2; xi++) {
                    s[tr-1] += SALES[xi-1];
                    steps.push({
                        line: 5, type: 'calc', sIdx: tr, pIdx: xi, val: s[tr-1], 
                        msg: `Î±Î¸Ï[${tr}] + Î Î©Î›[${xi}]`
                    });
                }
                steps.push({line: 7, type: 'print', txt: `Î‘Î¸Ï[${tr}]: ${s[tr-1]}`, msg: `Î•Î¼Ï†Î¬Î½Î¹ÏƒÎµ`});
                steps.push({line: 7, type: 'color', q: tr, msg: "ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î¤ÏÎ¹Î¼Î®Î½Î¿Ï…"});
                limit += 3;
                steps.push({line: 8, msg: `Î¿ÏÎ¹Î¿ <- ${limit}`});
            }
        }
        else if(currentSol === 4) {
            let q = 1;
            for(let i=1; i<=10; i+=3) {
                steps.push({line: 1, msg: `Î“Î¹Î± Î¹=${i}`});
                
                let sum = SALES[i-1] + SALES[i] + SALES[i+1];
                s[q-1] = sum;
                
                steps.push({
                    line: 2, type: 'calc_multi', pIdxs: [i, i+1, i+2], sIdx: q, val: sum,
                    msg: `Î±Î¸Ï <- Î Î©Î›[${i}] + Î Î©Î›[${i+1}] + Î Î©Î›[${i+2}]`
                });
                
                steps.push({line: 3, type: 'print', txt: `Î‘Î¸Ï: ${sum}`, msg: `Î“ÏÎ¬ÏˆÎµ`});
                steps.push({line: 3, type: 'color', q: q, msg: "ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î¤ÏÎ¹Î¼Î®Î½Î¿Ï…"});
                q++;
            }
        }
    }

    function step() {
        if (isAnimating) return;
        if (stepIdx >= steps.length) return; 

        const s = steps[stepIdx];
        isAnimating = true;
        
        // Only disable Step button, keep others functional but ignored via logic
        document.getElementById('btnStep').disabled = true;

        const onStepComplete = () => {
            isAnimating = false;
            document.getElementById('btnStep').disabled = false;
            stepIdx++;
            
            if (stepIdx < steps.length) {
                highlightLine(steps[stepIdx].line);
                document.getElementById('narrativeBox').innerText = steps[stepIdx].msg;
                if (isPlaying) timer = setTimeout(step, speed * 0.5);
            } else {
                document.getElementById('narrativeBox').innerText = "Î¤Î­Î»Î¿Ï‚ Î•ÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚.";
                document.getElementById('btnPlay').innerText = "â–¶ï¸ Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·";
                isPlaying = false;
                highlightLine(-1);
                clearAnims();
                toggleControls(true); // Re-enable control buttons visually
            }
        };

        clearAnims();
        highlightLine(s.line);
        document.getElementById('narrativeBox').innerText = s.msg;

        const d = speed * 0.3;

        setTimeout(() => {
            if (s.type === 'calc') {
                animRead(s.pIdx);
                setTimeout(() => animWrite(s.sIdx, s.val), d);
                setTimeout(onStepComplete, d * 2.5);
            }
            else if (s.type === 'calc_multi') {
                s.pIdxs.forEach(pid => animRead(pid));
                setTimeout(() => animWrite(s.sIdx, s.val), d);
                setTimeout(onStepComplete, d * 2.5);
            }
            else if (s.type === 'color') {
                colorQuarter(s.q);
                setTimeout(onStepComplete, d);
            }
            else if (s.type === 'print') {
                logOutput(s.txt);
                setTimeout(onStepComplete, d);
            }
            else {
                setTimeout(onStepComplete, d);
            }
        }, d);
    }

    function toggleOrient() {
        isVertical = !isVertical;
        const cont = document.getElementById('vizContent');
        const btn = document.getElementById('btnOrient');
        
        if(isVertical) {
            cont.classList.add('vertical');
            btn.innerText = "ğŸ”„ ÎŸÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î±";
        } else {
            cont.classList.remove('vertical');
            btn.innerText = "ğŸ”„ ÎšÎ¬Î¸ÎµÏ„Î±";
        }
    }

    function toggleControls(enable) {
        // Only visual toggling for solution buttons to prevent flickering
        const cursor = enable ? 'pointer' : 'default';
        document.querySelectorAll('.sol-btn').forEach(b => {
            b.classList.toggle('locked', !enable);
        });
        // Real disabling only for Play/Step if needed
    }

    function play() {
        if (isAnimating) return;
        if (!isPlaying) {
            if (stepIdx >= steps.length) resetSim();
            isPlaying = true;
            document.getElementById('btnPlay').innerText = "â¸ Î Î±ÏÏƒÎ·";
            toggleControls(false); // Lock solution buttons
            step();
        } else {
            isPlaying = false;
            clearTimeout(timer);
            document.getElementById('btnPlay').innerText = "â–¶ï¸ Î•ÎºÏ„Î­Î»ÎµÏƒÎ·";
            toggleControls(true); // Unlock
        }
    }

    function updateSpeed() {
        var sliderVal = parseInt(document.getElementById('speedSlider').value);
        speed = 2100 - sliderVal;
    }

    init();

</script>
</body>
</html>